<section class="page-section" id="contact">
    <div class="text-center">
        <h2 class="section-heading">Experimentos</h2>
    </div>
    <div class="align-items-stretch justify-content-center mb-5">
        <div class="about-heading-content">
            <div class="col-xl-9 col-lg-10 mx-auto">
                <div class="bg-faded rounded p-5">
                    <table class="experimento-list table table-striped">
                        <thead>
                            <tr>
                                <th class="text_table text_header_color" scope="col">Tipo</th>
                                <th class="text_table text_header_color" scope="col">Nombre</th>
                                <th class="text_table text_header_color" scope="col">Duración</th>
                                <th class="text_table text_header_color" scope="col">Repeticiones</th>
                                <th class="text_table text_header_color" scope="col">Microservicio/Namespace</th>
                                <th class="text_table text_header_color" scope="col">Endpoints/Configuración</th>
                                <th class="text_table text_header_color" scope="col"></th>
                                <th class="text_table text_header_color" scope="col">Acciones</th>
                                <th class="text_table text_header_color" scope="col"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (exp of groupedExperimentos | paginate:{itemsPerPage: 10, currentPage: p}; track
                            exp.experiment_id) {
                            <tr class="text_table">
                                <td>
                                    @for (tipo of exp.tipos; track tipo; let isLast = $last) {
                                        @if (tipo === 'K6') {
                                            <span class="badge bg-primary">K6</span>
                                        } @else if (tipo === 'Chaos') {
                                            <span class="badge bg-warning text-dark">Chaos</span>
                                        }
                                        @if (!isLast) {
                                            <br>
                                        }
                                    }
                                </td>
                                <td>
                                    <span>{{exp.nombre}}</span>
                                    <span class="status-indicator" 
                                          [style.background-color]="getStatusColor(exp.status)"
                                          [title]="getStatusText(exp.status)">
                                    </span>
                                </td>
                                <td>{{exp.duracion}}</td>
                                <td>{{exp.cant_replicas}}</td>
                                <td>
                                    @if (exp.k6Experimento && exp.k6Experimento.despliegues && exp.k6Experimento.despliegues.length > 0) {
                                        @for (despliegue of exp.k6Experimento.despliegues; track $index){
                                        <ul class="custom-list">
                                            <li>{{despliegue.nombre}}</li>
                                        </ul>
                                        }
                                    }
                                    @if (exp.chaosExperimento && exp.namespace) {
                                        @if (exp.k6Experimento) {
                                            <br>
                                        }
                                        <span class="text-muted">Namespace:</span>
                                        <br>
                                        <strong>{{exp.namespace}}</strong>
                                    }
                                </td>
                                <td class="text_table">
                                    @if (exp.k6Experimento && exp.k6Experimento.endpoints && exp.k6Experimento.endpoints.length > 0) {
                                        @for (endpoint of exp.k6Experimento.endpoints; track $index){
                                        <ul>
                                            <li>{{endpoint}}</li>
                                        </ul>
                                        }
                                    }
                                    @if (exp.chaosExperimento && exp.configuracion_chaos) {
                                        @if (exp.k6Experimento) {
                                            <br>
                                            <hr style="margin: 5px 0;">
                                        }
                                        <span class="text-muted">Tipo:</span> {{exp.tipo_chaos}}
                                        <br>
                                        <small class="text-muted">
                                            Modo: {{getChaosMode(exp.configuracion_chaos)}}
                                        </small>
                                    }
                                </td>
                                <td>
                                    <div class="flex-row">

                                        <a class="btn btn-outline-dark btn-icon"
                                        [routerLink]="[ROUTES_APP.VER_PROYECTO, exp.id_experimento]">
                                        Ver
                                    </a>
                                    @if (exp.k6Experimento) {
                                            <a class="btn btn-outline-info btn-icon"
                                            (click)="descargarResultados(exp.k6Experimento!.id_experimento)">
                                            Resultados
                                            </a>
                                        } @else if (exp.chaosExperimento) {
                                            <a class="btn btn-outline-info btn-icon"
                                            (click)="descargarResultados(exp.chaosExperimento!.id_experimento)">
                                            Resultados
                                            </a>
                                        } @else {
                                                <span class="text-muted">N/A</span>
                                            }
                                    <a class="btn btn-outline-danger btn-icon"
                                    (click)="eliminarExperimento(exp)">
                                        Eliminar
                                    </a>
                                    </div>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                    <div class="text-center form-conent">
                        <pagination-controls (pageChange)="p = $event" previousLabel="Anterior"
                            nextLabel="Siguiente"></pagination-controls>
                    </div>
                    <div class="text-center form-conent">
                        <button class="btn btn-primary btn-xl" id="submitButton" type="submit"
                            [routerLink]="ROUTES_APP.CREAR_PROYECTO">Crear proyecto</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@if (mostrarSelectorMetricas) {
    <app-metrica-selector
        [gruposMetricas]="gruposMetricas"
        [metricasSeleccionadas]="metricasSeleccionadas"
        (metricasChange)="onMetricasChange($event)"
        (cerrar)="aplicarMetricas()">
    </app-metrica-selector>
}
