<section class="page-section" id="contact">
  <div class="container">
    <div class="text-center">
      <h2 class="section-heading">Configurar Experimento</h2>
    </div>
    <form [formGroup]="experimentoForm" id="contactForm" class="row g-3 needs-validation" novalidate>
      <div class="row align-items-stretch justify-content-center mb-5">
        <div class="col-md-7 center">
          <div class="col-md-6">
            <div class="form-group">
              <label class="section-label" for="inputNombre4">Nombre</label>
              <input type="text" formControlName="nombre" class="form-control"
                placeholder="Nombre del experimento" id="inputNombre4" min="1" required />
              <div class="invalid-feedback">
                Nombre requerida
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label class="section-label" for="inputDuracion4">Duración del experimento</label>
              <input type="text" formControlName="duracion" class="form-control"
                placeholder="Duracion. Ej: 4m" id="inputDuracion4" min="1" required/>

              <div class="invalid-feedback">
                Duración requerida
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-group">
              <label for="inputReplicas4" class="section-label">No. Repeticiones</label>
              <input type="number" formControlName="replicas" placeholder="Número de repeticiones" id="inputReplicas4"
                class="form-control" min="1" required />
              <div class="invalid-feedback">
                Número de repeticiones es requerido
              </div>
              <small class="form-text text-muted">Habrá un delay de 1 minuto entre cada repetición</small>
            </div>
          </div>

          <label for="inputDescription4" class="section-label">Elige los Microservicios del experimento </label>
          
          <div formGroupName="cargaForm">
            <table class="proyecto-list table table-striped">
              <thead>
                <tr>
                  <th class="text_table" scope="col">Microservicio</th>
                  <th class="text_table" scope="col">Opción</th>
                </tr>
              </thead>
              <tbody>
                @for (carga of cargas.controls | paginate:{itemsPerPage: 10, currentPage: p}; track
                $index){
                <tr class="text_table">
                  <td>
                    
                    <p>
                      {{ carga.get('despliegue')?.value.nombre }}
                    </p>

                    <endpoints [despliegueId]="carga.get('despliegue')?.value.id_despliegue"></endpoints>

                  </td>

                  <td><button type="button" class="btn btn-outline-primary"
                      (click)="addEndpoint(carga.get('despliegue')?.value.id_despliegue)">Añadir</button>
                  </td>

                </tr>

                }
              </tbody>
            </table>
            <div class="text-center form-conent">
              <pagination-controls (pageChange)="p = $event" previousLabel="Anterior"
                nextLabel="Siguiente"></pagination-controls>
            </div>
          </div>
          
          <div class="col-12 mt-4 mb-4">
            <div class="text-center form-conent">
              <button type="button" class="btn btn-danger btn-xl" (click)="toggleChaosForm()">
                {{ showChaosForm ? 'Ocultar' : 'Añadir' }} inyección de fallos
              </button>
            </div>

            @if (showChaosForm) {
              <div class="card mt-3" style="background-color: #f8f9fa;">
                <div class="card-body">
                  <h5 class="card-title section-label mb-3">Configurar Inyección de Fallos</h5>
                  <form [formGroup]="chaosForm">
                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="section-label" for="chaosType">Tipo de Caos</label>
                          <select formControlName="type" class="form-control" id="chaosType" (change)="onChaosTypeChange()">
                            <option value="">Seleccione un tipo</option>
                            @for (type of chaosTypes; track type) {
                              <option [value]="type">{{ type }}</option>
                            }
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="section-label" for="chaosMicroservice">Microservicio</label>
                          <select formControlName="selectedMicroservice" class="form-control" 
                            id="chaosMicroservice" (change)="onMicroserviceChange()">
                            <option value="">Seleccione un microservicio</option>
                            @for (despliegue of despliegues; track despliegue.id_despliegue) {
                              <option [value]="despliegue.id_despliegue">{{ despliegue.nombre }} ({{ despliegue.namespace }})</option>
                            }
                          </select>
                        </div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="section-label" for="chaosMode">Modo</label>
                          <select formControlName="mode" class="form-control" id="chaosMode">
                            @for (mode of chaosModes; track mode) {
                              <option [value]="mode">{{ mode }}</option>
                            }
                          </select>
                        </div>
                      </div>
                      <div class="col-md-6">
                        <div class="form-group">
                          <label class="section-label" for="chaosValue">Valor (para fixed/fixed-percent)</label>
                          <input type="number" formControlName="value" class="form-control" 
                            id="chaosValue" placeholder="1" />
                        </div>
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-12">
                        <div class="form-group">
                          <label class="section-label" for="chaosName">Nombre (opcional)</label>
                          <input type="text" formControlName="name" class="form-control" 
                            id="chaosName" placeholder="Nombre del experimento" />
                          <small class="form-text text-muted">Si no se especifica, se generará automáticamente</small>
                        </div>
                      </div>
                    </div>

                    @if (selectedChaosType === 'network-delay') {
                      <div class="row mt-3" style="background-color: #e9ecef; padding: 15px; border-radius: 5px;">
                        <h6 class="section-label mb-3">Configuración de Retraso de Red</h6>
                        <div class="col-md-4">
                          <div class="form-group">
                            <label class="section-label" for="networkDelayLatency">Latencia (ms)</label>
                            <input type="text" formControlName="networkDelayLatency" class="form-control" 
                              id="networkDelayLatency" placeholder="1000" />
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-group">
                            <label class="section-label" for="networkDelayJitter">Jitter (ms, opcional)</label>
                            <input type="text" formControlName="networkDelayJitter" class="form-control" 
                              id="networkDelayJitter" placeholder="100" />
                          </div>
                        </div>
                        <div class="col-md-4">
                          <div class="form-group">
                            <label class="section-label" for="networkDelayCorrelation">Correlación (%, opcional)</label>
                            <input type="text" formControlName="networkDelayCorrelation" class="form-control" 
                              id="networkDelayCorrelation" placeholder="50" />
                          </div>
                        </div>
                      </div>
                    }

                    @if (selectedChaosType === 'network-loss') {
                      <div class="row mt-3" style="background-color: #e9ecef; padding: 15px; border-radius: 5px;">
                        <h6 class="section-label mb-3">Configuración de Pérdida de Red</h6>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label class="section-label" for="networkLossLoss">Pérdida (%)</label>
                            <input type="text" formControlName="networkLossLoss" class="form-control" 
                              id="networkLossLoss" placeholder="50" />
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label class="section-label" for="networkLossCorrelation">Correlación (%, opcional)</label>
                            <input type="text" formControlName="networkLossCorrelation" class="form-control" 
                              id="networkLossCorrelation" placeholder="50" />
                          </div>
                        </div>
                      </div>
                    }

                    @if (selectedChaosType === 'network-bandwidth') {
                      <div class="row mt-3" style="background-color: #e9ecef; padding: 15px; border-radius: 5px;">
                        <h6 class="section-label mb-3">Configuración de Ancho de Banda</h6>
                        <div class="col-md-12">
                          <div class="form-group">
                            <label class="section-label" for="networkBandwidthRate">Tasa (ej: 1mbps)</label>
                            <input type="text" formControlName="networkBandwidthRate" class="form-control" 
                              id="networkBandwidthRate" placeholder="1mbps" />
                          </div>
                        </div>
                      </div>
                    }

                    @if (isStressType(selectedChaosType)) {
                      <div class="row mt-3" style="background-color: #e9ecef; padding: 15px; border-radius: 5px;">
                        <h6 class="section-label mb-3">Configuración de Estrés</h6>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label class="section-label" for="stressWorkers">Workers</label>
                            <input type="number" formControlName="stressWorkers" class="form-control" 
                              id="stressWorkers" placeholder="4" />
                          </div>
                        </div>
                        <div class="col-md-6">
                          <div class="form-group">
                            <label class="section-label" for="stressLoad">Carga (%)</label>
                            <input type="number" formControlName="stressLoad" class="form-control" 
                              id="stressLoad" placeholder="80" />
                          </div>
                        </div>
                      </div>
                    }

                    <div class="text-center form-conent mt-3">
                      <button type="button" class="btn btn-success btn-xl" (click)="addChaosExperiment()">
                        Añadir Falla
                      </button>
                    </div>
                  </form>
                </div>
              </div>
            }

            @if (chaosExperiments.length > 0) {
              <div class="card mt-3">
                <div class="card-body">
                  <h5 class="card-title section-label mb-3">Experimentos de Caos Añadidos ({{ chaosExperiments.length }})</h5>
                  <div class="table-responsive">
                    <table class="table table-striped">
                      <thead>
                        <tr>
                          <th>Tipo</th>
                          <th>Namespace</th>
                          <th>Selector</th>
                          <th>Modo</th>
                          <th>Acción</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (experiment of chaosExperiments; track $index) {
                          <tr>
                            <td>{{ experiment.type }}</td>
                            <td>{{ experiment.namespace }}</td>
                            <td>{{ formatSelector(experiment.selector) }}</td>
                            <td>{{ experiment.mode }}</td>
                            <td>
                              <button type="button" class="btn btn-sm btn-danger" 
                                (click)="removeChaosExperiment($index)">
                                Eliminar
                              </button>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            }
          </div>

          <div class="col-12 d-flex justify-content-end mt-3">
            <div class="text-center form-conent">
              <button type="submit" class="btn btn-primary btn-xl" (click)="createExperiment()">
                <a class="btn btn-primary btn-xl">
                  Siguiente
                </a></button>
              </div>
          </div>
          @if(status){
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
          </div>
          }
        </div>
      </div>
    </form>
  </div>
  <script src="../../../../assets/js/checkout_pages.js"></script>
</section>
